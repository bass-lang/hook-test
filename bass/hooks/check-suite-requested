#!/usr/bin/env bass

(use (.git (linux/alpine/git))
     (*dir*/check))

(defn main []
  (for [{:repository {:full-name repo
                      :clone-url clone-url}
         :check-suite {:head-sha sha
                       :app {:id app-id}}
         :installation {:id inst-id}} *stdin*]
    (let [src (git:checkout clone-url sha)
          project (load (src/project))
          checks (project:checks src)]
      (map (fn ({:name name :thunk thunk})
             (check:run thunk name sha repo inst-id app-id))
           checks))))
